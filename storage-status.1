.TH STORAGE-STATUS 1 "2025-12-08" "storage-status" "User Commands"
.SH NAME
storage-status \- terminal dashboard for Ubuntu/ZFS storage servers
.SH SYNOPSIS
.B storage-status
[\fB\-\-remote\fR]
[\fB\-\-local\fR]
[\fB\-\-once\fR]
[\fIview\fR]
.SH DESCRIPTION
.B storage-status
displays a real-time terminal dashboard for monitoring Ubuntu/ZFS storage servers.
It can run locally on the storage server or remotely via SSH, with automatic detection
of the execution environment.
.PP
The dashboard shows ZFS pool status, dataset usage, system resources, service status,
network interfaces, and SMB/NFS connections.
.SH OPTIONS
.TP
.BR \-\-remote
Force remote mode. Connect to the storage server via SSH even if running locally.
.TP
.BR \-\-local
Force local mode. Run commands directly without SSH.
.TP
.BR \-\-once
Display the dashboard once and exit. No live refresh or keyboard interaction.
.TP
.IR view
Show only a specific panel. Valid values:
.BR pools ", " datasets ", " services ", " network ", " smb .
.SH KEYBOARD CONTROLS
When running in live mode (without \fB\-\-once\fR):
.TP
.B 1\-6
Expand the corresponding panel to full screen.
Panel numbers are shown in the panel titles.
Currently implemented: \fB2\fR for ZFS Datasets, \fB3\fR for Services details, \fB4\fR for Network details, \fB5\fR for SMB details, \fB6\fR for NFS details.
.TP
.B Esc / Backspace
Return to the main dashboard from an expanded view.
.TP
.B t
Toggle between SMB and NFS connections panel.
.TP
.B Tab
Same as \fBt\fR.
.TP
.B q
Quit the dashboard.
.TP
.B Ctrl+C
Quit the dashboard.
.SH DASHBOARD PANELS
.SS ZFS Pools
Displays pool name, size, allocated space, free space, capacity percentage, health status,
and deduplication ratio. The capacity bar is color-coded:
.RS
.IP \(bu 2
Green: < 75% usage
.IP \(bu 2
Yellow: 75-89% usage
.IP \(bu 2
Red: >= 90% usage
.RE
.SS ZFS Datasets
Hierarchical view of datasets with used space, available space, and compression ratio.
Child datasets are indented to show the hierarchy.
.SS System Resources
Shows CPU load averages (1/5/15 min), memory usage with a color-coded progress bar,
and system uptime.
.SS Services
Status of critical services: smbd, nfs-server, zfs-import-cache, zfs-mount, ssh.
.RS
.IP \(bu 2
\fB●\fR Running (green): Service is active
.IP \(bu 2
\fB✓\fR Completed (green): One-shot service completed successfully
.IP \(bu 2
\fB○\fR Stopped (yellow): Service is inactive
.IP \(bu 2
\fB✗\fR Failed (red): Service failed
.RE
.SS Network Interfaces
Lists network interfaces with their state (UP/DOWN) and IP addresses.
.SS SMB/NFS Connections
Toggleable panel showing either SMB connections (user and machine) or NFS connections
(client IP addresses). Press \fBt\fR to toggle. The panel title shows counts for both.
Multiple connections from the same client are deduplicated with a count suffix (e.g., "x2").
.SS ZFS Datasets Expanded View
Press \fB2\fR to view detailed ZFS dataset information in a comprehensive table:
.RS
.IP \(bu 2
Dataset name (with hierarchical indentation), used space, available space, referenced data
.IP \(bu 2
Compression ratio, quota, reservation, record size
.IP \(bu 2
Snapshot count per dataset and mountpoint
.RE
.PP
Supports scrolling with arrow keys or j/k for large dataset lists.
.SS Services Expanded View
Press \fB3\fR to view detailed service information in two sections:
.RS
.IP \(bu 2
\fBRunning Services\fR \- Active and completed services showing service name, state,
PID, memory usage, runtime, restart count, and description.
.IP \(bu 2
\fBStopped/Failed Services\fR \- Inactive and failed services showing service name,
state, restart count, and description.
.RE
.PP
Monitors 13 services: smbd, nfs-server, zfs-import-cache, zfs-mount, ssh, docker,
containerd, rsync, rpcbind, nfs-mountd, smartd, zed, cron.
.SS Network Expanded View
Press \fB4\fR to view detailed network interface information in a single comprehensive table:
.RS
.IP \(bu 2
Interface name, state (UP/DOWN), link speed (e.g., 10G, 1G), MAC address, and MTU
.IP \(bu 2
IP addresses assigned to each interface
.IP \(bu 2
Traffic statistics: bytes received (RX), bytes transmitted (TX), and error counts
.RE
.SS SMB Expanded View
Press \fB5\fR to view detailed SMB information in two sections:
.RS
.IP \(bu 2
\fBActive Connections\fR \- SMB sessions showing client hostname/IP, username,
protocol version (e.g., SMB3_11), and connection time.
.IP \(bu 2
\fBConfigured Shares\fR \- SMB shares from \fIsmb.conf\fR showing share name, path,
valid users, and access mode (Read/Write or Read Only).
.RE
.SS NFS Expanded View
Press \fB6\fR to view detailed NFS information in two sections:
.RS
.IP \(bu 2
\fBActive Connections\fR \- TCP connections on port 2049 with client hostname (reverse DNS),
bytes sent/received, RTT latency, and last activity time.
.IP \(bu 2
\fBConfigured Exports\fR \- NFS exports from \fI/etc/exports\fR showing paths, allowed clients,
and export options.
.RE
.SH ENVIRONMENT
.TP
.B STORAGE_SSH_HOST
Required for remote mode. SSH host or alias for the storage server.
.TP
.B STORAGE_HOSTNAME
Optional. Hostname of the storage server for local detection. Compared against the output of
.BR hostname (1).
.TP
.B STORAGE_IPS
Optional. Comma-separated list of storage server IPs for local detection. Compared against
the output of
.BR "hostname -I" .
.SH CONFIGURATION
.SS Auto-Detection Algorithm
The tool determines execution mode as follows:
.RS
.IP 1. 3
Compare the current hostname to \fBSTORAGE_HOSTNAME\fR
.IP 2. 3
If no match, compare local IP addresses (from \fBhostname -I\fR) to \fBSTORAGE_IPS\fR
.IP 3. 3
If either matches, run in local mode; otherwise use SSH to \fBSTORAGE_SSH_HOST\fR
.RE
.PP
Use \fB\-\-local\fR or \fB\-\-remote\fR to override detection.
.SS SSH Setup
For non-interactive operation, configure SSH key authentication.
Choose based on your security requirements.
.PP
\fBStandard key with passphrase (recommended):\fR
.RS
.nf
ssh-keygen -t ed25519
eval "$(ssh-agent -s)" && ssh-add
ssh-copy-id user@storage-server
.fi
.RE
.PP
\fBHardware security key (FIDO2/YubiKey):\fR
.RS
.nf
ssh-keygen -t ed25519-sk
ssh-copy-id user@storage-server
.fi
.RE
.PP
Optionally add a host alias in \fI~/.ssh/config\fR:
.RS
.nf
Host storage-server
    HostName 10.0.0.10
    User admin
.fi
.RE
.SS Connection Multiplexing
The tool automatically uses SSH ControlMaster to reuse a single TCP connection
for all commands, significantly improving performance in remote mode.
The connection persists for 60 seconds after the last command.
.SS Required Permissions
The SSH user on the storage server needs access to:
.RS
.IP \(bu 2
\fBzpool\fR, \fBzfs\fR \- ZFS status commands
.IP \(bu 2
\fBsystemctl\fR \- Service status (read-only)
.IP \(bu 2
\fBsmbstatus\fR \- SMB connection details (may require \fBsambashare\fR group)
.IP \(bu 2
\fBtestparm\fR \- SMB share configuration
.IP \(bu 2
\fB/proc/loadavg\fR, \fB/proc/meminfo\fR \- System stats (world-readable)
.IP \(bu 2
\fBss\fR \- Socket statistics for NFS connections (with \fB-i\fR for extended metrics)
.IP \(bu 2
\fB/etc/exports\fR \- NFS export configuration (world-readable)
.RE
.SH EXAMPLES
.TP
.B storage-status
Start the live dashboard with auto-refresh every 5 seconds.
.TP
.B storage-status --once
Display current status once and exit.
.TP
.B storage-status pools
Show only ZFS pool information.
.TP
.B storage-status --remote
Force SSH connection even if running on the storage server.
.SH FILES
.TP
.I ~/.ssh/config
SSH configuration file. Define a host alias for cleaner configuration.
.SH EXIT STATUS
.TP
.B 0
Success
.TP
.B 1
Error (missing environment variables, SSH failure, etc.)
.SH TROUBLESHOOTING
.TP
.B Detection not working
Verify environment variables match your system:
.RS
.nf
hostname              # Should match STORAGE_HOSTNAME
hostname -I           # Should include IP from STORAGE_IPS
.fi
.RE
.TP
.B SSH connection fails
Test SSH independently with verbose output:
.RS
.nf
ssh -v $STORAGE_SSH_HOST hostname
.fi
.RE
.TP
.B Permission denied on smbstatus
Add the SSH user to the sambashare group on the storage server:
.RS
.nf
sudo usermod -aG sambashare $USER
.fi
.RE
.SH SEE ALSO
.BR zpool (8),
.BR zfs (8),
.BR systemctl (1),
.BR smbstatus (1)
.SH AUTHOR
Written for the in-the-terminal project.
